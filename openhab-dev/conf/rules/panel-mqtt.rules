// MQTT Bridge for ESP32 Panel
// Publishes OpenHAB item states to MQTT topics
// Uses retained=true so panel receives values even if it connects after change

val statePrefix = "homehab/state/"

rule "Publish HRV Output Power"
when
    Item hrvOutputPower changed
then
    val mqttActions = getActions("mqtt", "mqtt:broker:mosquitto")
    if (mqttActions !== null && hrvOutputPower.state !== NULL && hrvOutputPower.state !== UNDEF) {
        mqttActions.publishMQTT(statePrefix + "hrvOutputPower", hrvOutputPower.state.toString, true)
    }
end

rule "Publish Temperature"
when
    Item temperature changed
then
    val mqttActions = getActions("mqtt", "mqtt:broker:mosquitto")
    if (mqttActions !== null && temperature.state !== NULL && temperature.state !== UNDEF) {
        mqttActions.publishMQTT(statePrefix + "temperature", temperature.state.toString, true)
    }
end

rule "Publish Air Humidity"
when
    Item airHumidity changed
then
    val mqttActions = getActions("mqtt", "mqtt:broker:mosquitto")
    if (mqttActions !== null && airHumidity.state !== NULL && airHumidity.state !== UNDEF) {
        mqttActions.publishMQTT(statePrefix + "airHumidity", airHumidity.state.toString, true)
    }
end

rule "Publish CO2"
when
    Item co2 changed
then
    val mqttActions = getActions("mqtt", "mqtt:broker:mosquitto")
    if (mqttActions !== null && co2.state !== NULL && co2.state !== UNDEF) {
        mqttActions.publishMQTT(statePrefix + "co2", co2.state.toString, true)
    }
end

rule "Publish Pressure"
when
    Item pressure changed
then
    val mqttActions = getActions("mqtt", "mqtt:broker:mosquitto")
    if (mqttActions !== null && pressure.state !== NULL && pressure.state !== UNDEF) {
        mqttActions.publishMQTT(statePrefix + "pressure", pressure.state.toString, true)
    }
end

rule "Publish Manual Mode"
when
    Item manualMode changed
then
    val mqttActions = getActions("mqtt", "mqtt:broker:mosquitto")
    if (mqttActions !== null && manualMode.state !== NULL && manualMode.state !== UNDEF) {
        mqttActions.publishMQTT(statePrefix + "manualMode", manualMode.state.toString, true)
    }
end

rule "Publish Temporary Boost Mode"
when
    Item temporaryBoostMode changed
then
    val mqttActions = getActions("mqtt", "mqtt:broker:mosquitto")
    if (mqttActions !== null && temporaryBoostMode.state !== NULL && temporaryBoostMode.state !== UNDEF) {
        mqttActions.publishMQTT(statePrefix + "temporaryBoostMode", temporaryBoostMode.state.toString, true)
    }
end

rule "Publish Smoke"
when
    Item smoke changed
then
    val mqttActions = getActions("mqtt", "mqtt:broker:mosquitto")
    if (mqttActions !== null && smoke.state !== NULL && smoke.state !== UNDEF) {
        mqttActions.publishMQTT(statePrefix + "smoke", smoke.state.toString, true)
    }
end

rule "Publish Manual Power"
when
    Item manualPower changed
then
    val mqttActions = getActions("mqtt", "mqtt:broker:mosquitto")
    if (mqttActions !== null && manualPower.state !== NULL && manualPower.state !== UNDEF) {
        mqttActions.publishMQTT(statePrefix + "manualPower", manualPower.state.toString, true)
    }
end

// Handle commands from panel
rule "Panel Manual Power Command"
when
    Item panelManualPowerCommand received update
then
    if (panelManualPowerCommand.state !== NULL && panelManualPowerCommand.state !== UNDEF) {
        manualPower.sendCommand(panelManualPowerCommand.state.toString)
    }
end

rule "Panel Manual Mode Command"
when
    Item panelManualModeCommand received update
then
    if (panelManualModeCommand.state !== NULL && panelManualModeCommand.state !== UNDEF) {
        manualMode.sendCommand(panelManualModeCommand.state.toString)
    }
end

rule "Panel Boost Mode Command"
when
    Item panelBoostModeCommand received update
then
    if (panelBoostModeCommand.state !== NULL && panelBoostModeCommand.state !== UNDEF) {
        temporaryBoostMode.sendCommand(panelBoostModeCommand.state.toString)
    }
end
