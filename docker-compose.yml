# homeHAB Development Environment
# Uses .env.dev configuration (via .env symlink)
#
# Default mode: OpenHAB connects to production MQTT (zigbee.home)
# Simulator mode: Start mosquitto + mqtt-simulator for edge case testing
#
# Usage:
#   docker-compose up -d openhab influxdb grafana    # Normal dev (prod MQTT)
#   docker-compose up -d                              # All services (local MQTT)

services:

  # === Core Services (always running) ===

  openhab:
    container_name: ${COMPOSE_PROJECT_NAME}-server
    build:
      context: .
      dockerfile: Dockerfile
    image: homehab-openhab:5.0.0-jdk
    restart: unless-stopped
    ports:
      - "8888:8080"
      - "8889:8443"
    group_add:
      - tty
    volumes:
      - /etc/localtime:/etc/localtime
      - /etc/timezone:/etc/timezone
      - $OPENHAB_CONF/ssh:/openhab/.ssh
      - $OPENHAB_ADDONS:/openhab/addons
      - $OPENHAB_CONF:/openhab/conf
      - $OPENHAB_USERDATA:/openhab/userdata
    environment:
      - CRYPTO_POLICY=  # Disabled - Temurin JDK 21 uses unlimited by default
      - EXTRA_JAVA_OPTS=${EXTRA_JAVA_OPTS}
      - JAVA_HOME=/usr/lib/jvm/temurin-21-jdk-arm64
      - PATH=/usr/lib/jvm/temurin-21-jdk-arm64/bin:$PATH
    extra_hosts:
      - "zigbee.home:192.168.1.132"
      - "openhab.home:192.168.1.132"
      - "grafana.home:192.168.1.132"
      - "rpi.local:192.168.1.132"

  # === Optional: Local MQTT Simulator ===
  # Use for testing edge cases (smoke alarm, high CO2) without real hardware
  # Requires changing mqtt.things: host="mosquitto" instead of host="zigbee.home"

  mosquitto:
    container_name: ${COMPOSE_PROJECT_NAME}-mosquitto
    image: eclipse-mosquitto:2
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log

  # === Metrics & Visualization (always running) ===

  influxdb:
    container_name: ${COMPOSE_PROJECT_NAME}-influxdb
    image: influxdb:2
    restart: unless-stopped
    ports:
      - "8086:8086"
    volumes:
      - ./influxdb/data:/var/lib/influxdb2
      - ./influxdb/config:/etc/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=adminpassword
      - DOCKER_INFLUXDB_INIT_ORG=homehab
      - DOCKER_INFLUXDB_INIT_BUCKET=openhab

  grafana:
    container_name: ${COMPOSE_PROJECT_NAME}-grafana
    image: grafana/grafana:latest
    restart: unless-stopped
    ports:
      - "3030:3000"
    volumes:
      - ./grafana/data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - influxdb

  mqtt-simulator:
    container_name: ${COMPOSE_PROJECT_NAME}-mqtt-simulator
    build:
      context: ./mqtt-simulator
      dockerfile: Dockerfile
    restart: unless-stopped
    volumes:
      - ./mqtt-simulator/devices.yaml:/app/devices.yaml
    depends_on:
      - mosquitto
    environment:
      - MQTT_HOST=mosquitto
      - MQTT_PORT=1883
