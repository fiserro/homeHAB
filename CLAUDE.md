# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

homeHAB is an OpenHAB Java automation library project that provides a fluent API for delayed actions in OpenHAB automation scripts. The project is built with JDK 21 and uses the Java223 JSR223 engine (version 5.0.1-BETA4) for advanced Java-based automation scripting.

## Build Commands

### Compile the project
```bash
mvn clean compile
```

### Run tests
```bash
mvn test
```

### Run a single test
```bash
mvn test -Dtest=DelayedActionsTest
```

### Package the library
```bash
mvn clean package
```

## Architecture

### Module Structure

The project is divided into two main areas:

1. **Library Code** (`src/main/java/com/example/lib/`)
   - `DelayedActions.java` - The core fluent API library for scheduling delayed actions
   - This is the reusable component meant to be deployed to OpenHAB's `automation/lib/java/` directory

2. **Example Scripts** (`src/main/java/com/example/scripts/`)
   - `MotionDetectorRule.java` - Practical example: motion-activated light with auto-off timer
   - `DelayedActionsExample.java` - Comprehensive examples of all API features
   - These are meant to be deployed to OpenHAB's `automation/jsr223/` directory

### Key Design Patterns

**Fluent API for Delayed Actions:**
The DelayedActions library wraps OpenHAB's `Scheduler` service to provide an intuitive API:
```java
DelayedActions.wait(60, SECONDS).then(() -> action());
DelayedActions.wait(5, ChronoUnit.MINUTES).then(() -> action());
```

Returns `ScheduledCompletableFuture<Void>` which can be cancelled or chained with error handling.

**Auto-Injection:**
Java223 automatically injects OpenHAB services into script fields. Key services:
- `ScriptBusEvent events` - For sending commands to items
- `Scheduler scheduler` - For scheduling delayed actions

**ScriptBusEvent API:**
The correct way to interact with OpenHAB items from scripts:
```java
events.sendCommand("itemName", "ON");
events.sendCommand("itemName", "OFF");
events.postUpdate("itemName", "100");
```

Do NOT use `ItemRegistry.get()` which returns the `Item` interface without a `send()` method.

**Rule Annotations:**
Scripts use annotations from `helper.rules.annotations` package:
```java
@Rule(name = "rule.name", description = "Description")
@ItemStateUpdateTrigger(itemName = "itemName", state = "ON")
public void onTrigger() { ... }
```

**Lombok for Logging:**
All classes use `@Slf4j` annotation instead of manual logger initialization:
```java
@Slf4j
public class MyScript {
    public void method() {
        log.info("Message");
    }
}
```

## Dependencies

### Critical Dependency Notes

1. **OpenHAB artifacts are NOT in public Maven repos**. They must be compiled locally:
   - OpenHAB Core 5.0.1: Clone from https://github.com/openhab/openhab-core
   - Java223 bundle: Clone from https://github.com/dalgwen/openhab-addons (branch 5.0.1-java223-BETA4)

2. **Java223 Helper Library** (`org.openhab.automation.java223-lib`) is referenced as a system dependency:
   - Path: `~/.m2/repository/org/openhab/addons/bundles/org.openhab.automation.java223/5.0.1/org.openhab.automation.java223-5.0.1-lib.jar`
   - Contains Rule annotations (`@Rule`, `@ItemStateUpdateTrigger`)

3. **All OpenHAB dependencies use `provided` scope** - they are provided by the OpenHAB runtime

4. **Example scripts are excluded from compilation** - they compile only in OpenHAB runtime (see `pom.xml` compiler plugin configuration)

### Compiling OpenHAB Dependencies Locally

If dependencies are missing, compile them:

```bash
# OpenHAB Core 5.0.1
cd /path/to/openhab-core
git checkout 5.0.1
mvn clean install -DskipTests -Dspotless.check.skip=true -T1C

# Java223 Bundle
cd /path/to/openhab-addons-java223/bundles/org.openhab.automation.java223
mvn clean install -DskipTests -Dspotless.check.skip=true
```

## Deployment to OpenHAB

### Deploy Library
```bash
cp target/homeHAB-1.0-SNAPSHOT.jar $OPENHAB_CONF/automation/lib/java/
```

### Deploy Scripts
```bash
cp src/main/java/com/example/scripts/*.java $OPENHAB_CONF/automation/jsr223/
```

OpenHAB automatically detects, compiles, and loads `.java` files from the `automation/jsr223/` directory.

## Common Pitfalls

### Static Import Collision
Avoid static import of `DelayedActions.wait()` as it collides with `Object.wait()`:
```java
// BAD
import static com.example.lib.DelayedActions.wait;
wait(5, MINUTES).then(() -> ...);  // Compilation error

// GOOD
DelayedActions.wait(5, MINUTES).then(() -> ...);
```

### Package Name: `helper.rules.annotations` (plural)
The correct package is `helper.rules.annotations` NOT `helper.rules.annotation` (singular).

### No Fake Generated Classes
Do NOT create stub classes for `helper.generated.*` - these are dynamically generated by OpenHAB at runtime.

## Language Guidelines

**Code and Documentation:**
- All code comments, JavaDoc, design documents (*.md), and technical documentation MUST be written in **English**
- This includes:
  - JavaDoc comments (`/** ... */`)
  - Inline code comments (`//`)
  - Design documents (DESIGN.md, README.md, etc.)
  - Commit messages
  - Variable names, method names, class names

**Communication:**
- Czech language is used ONLY for direct communication with the user
- When discussing code or design, use Czech for explanations but keep code examples in English

**Example:**
```java
/**
 * Calculates HRV power based on aggregated inputs.
 *
 * @param inputs Aggregated sensor inputs
 * @return Calculated power output (0-100%)
 */
public int calculate(Map<HrvInputType, Object> inputs) {
    // Priority 1: Safety override
    if (isTrue(inputs.get(HrvInputType.SMOKE_DETECTOR))) {
        log.info("Smoke detected - max ventilation");
        return config.getSmokePower();
    }
    // ...
}
```

## References

- OpenHAB Java223 Documentation: https://github.com/dalgwen/openhab-addons/blob/5.0.1-java223-BETA4/bundles/org.openhab.automation.java223/README.md
- OpenHAB Scheduler API: https://www.openhab.org/javadoc/latest/org/openhab/core/scheduler/scheduler
- OpenHAB JSR223 Documentation: https://www.openhab.org/docs/configuration/jsr223.html
