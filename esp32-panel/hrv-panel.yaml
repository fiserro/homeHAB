# HRV Control Panel for OpenHAB
# ESP32-P4-86-Panel-ETH-2RO

substitutions:
  name: hrv-panel
  friendly_name: HRV Control Panel
  # Screen auto-dim timeout in seconds (0 = disabled)
  screen_timeout: "60"

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  platformio_options:
    board_build.flash_mode: dio
  on_boot:
    priority: -100  # Run after network is connected
    then:
      - delay: 5s  # Wait for network to be ready
      - script.execute: fetch_initial_states

esp32:
  board: esp32-p4-evboard
  flash_size: 32MB
  cpu_frequency: 400MHz
  framework:
    type: esp-idf
    advanced:
      enable_idf_experimental_features: yes

logger:
  level: DEBUG
  hardware_uart: UART0

ota:
  platform: esphome

web_server:
  port: 80

psram:
  speed: 200MHz

# LDO for display
esp_ldo:
  - channel: 3
    voltage: 2.5V

# HTTP Request for REST API
http_request:
  verify_ssl: false
  timeout: 10s

# Ethernet (IP101 PHY)
ethernet:
  type: IP101
  mdc_pin: GPIO31
  mdio_pin: GPIO52
  clk:
    pin: GPIO50
    mode: CLK_EXT_IN
  phy_addr: 1
  power_pin: GPIO51

# MQTT for OpenHAB
mqtt:
  broker: zigbee.home
  port: 1883
  topic_prefix: homehab/panel

  birth_message:
    topic: homehab/panel/status
    payload: online
  will_message:
    topic: homehab/panel/status
    payload: offline

  on_message:
    # HRV Output Power
    - topic: homehab/state/hrvOutputPower
      then:
        - lambda: |-
            int power = atoi(x.c_str());
            id(power_value) = power;
            lv_arc_set_value(id(arc_power), power);
            lv_label_set_text_fmt(id(lbl_power_value), "%d%%", power);
            // Color based on value
            lv_color_t color;
            if (power > 80) color = lv_color_hex(0xFF0000);
            else if (power > 50) color = lv_color_hex(0xFFA500);
            else color = lv_color_hex(0x00FF00);
            lv_obj_set_style_arc_color(id(arc_power), color, LV_PART_INDICATOR);

    # Temperature
    - topic: homehab/state/temperature
      then:
        - lambda: |-
            ESP_LOGI("panel", "MQTT temperature: '%s'", x.c_str());
            float temp = atof(x.c_str());
            int temp_int = (int)(temp * 10);
            int whole = temp_int / 10;
            int frac = temp_int % 10;
            if (frac < 0) frac = -frac;
            lv_label_set_text_fmt(id(lbl_temp_value), "%d.%d", whole, frac);

    # Air Humidity
    - topic: homehab/state/airHumidity
      then:
        - lambda: |-
            int hum = atoi(x.c_str());
            lv_label_set_text_fmt(id(lbl_humidity_value), "%d", hum);

    # CO2
    - topic: homehab/state/co2
      then:
        - lambda: |-
            int co2 = atoi(x.c_str());
            lv_label_set_text_fmt(id(lbl_co2_value), "%d", co2);
            // Color based on level
            lv_color_t color;
            if (co2 > 900) color = lv_color_hex(0xFF0000);
            else if (co2 > 700) color = lv_color_hex(0xFFA500);
            else color = lv_color_hex(0x00FF00);
            lv_obj_set_style_text_color(id(lbl_co2_value), color, 0);

    # Manual Mode state (permanent manual)
    - topic: homehab/state/manualMode
      then:
        - lambda: |-
            ESP_LOGI("panel", "MQTT manualMode = %s", x.c_str());
            id(manual_mode_active) = (x == "ON");
        - script.execute: update_button_colors

    # Temporary Manual Mode state
    - topic: homehab/state/temporaryManualMode
      then:
        - lambda: |-
            ESP_LOGI("panel", "MQTT temporaryManualMode = %s", x.c_str());
            id(temp_manual_mode_active) = (x == "ON");
        - script.execute: update_button_colors

    # Temporary Boost Mode state
    - topic: homehab/state/temporaryBoostMode
      then:
        - lambda: |-
            ESP_LOGI("panel", "MQTT temporaryBoostMode = %s", x.c_str());
            id(boost_mode_active) = (x == "ON");
        - script.execute: update_button_colors

    # Smoke detector (color only: green = OK, red = alarm)
    - topic: homehab/state/smoke
      then:
        - lambda: |-
            bool alarm = (x == "ON");
            lv_obj_set_style_bg_color(id(smoke_indicator),
              alarm ? lv_color_hex(0xFF0000) : lv_color_hex(0x00c853), 0);

    # Gas detector (color only: green = OK, red = alarm)
    - topic: homehab/state/gas
      then:
        - lambda: |-
            bool alarm = (x == "ON");
            lv_obj_set_style_bg_color(id(gas_indicator),
              alarm ? lv_color_hex(0xFF0000) : lv_color_hex(0x00c853), 0);

    # Bypass state (color only: gray = off, blue = on)
    - topic: homehab/state/bypass
      then:
        - lambda: |-
            ESP_LOGI("panel", "MQTT bypass = %s", x.c_str());
            id(bypass_active) = (x == "ON");
            lv_obj_set_style_bg_color(id(btn_bypass),
              id(bypass_active) ? lv_color_hex(0x2196F3) : lv_color_hex(0x37474F), 0);

    # Manual Power (sync slider with OpenHAB value)
    - topic: homehab/state/manualPower
      then:
        - lambda: |-
            // Set flag to ignore slider events triggered by programmatic update
            id(ignore_slider_events) = true;
            int power = atoi(x.c_str());
            lv_slider_set_value(id(slider_manual_power), power, LV_ANIM_ON);
        - delay: 200ms
        - lambda: |-
            id(ignore_slider_events) = false;

    # Pressure
    - topic: homehab/state/pressure
      then:
        - lambda: |-
            ESP_LOGI("panel", "MQTT pressure: '%s'", x.c_str());
            int pressure = (int)(atof(x.c_str()) + 0.5);
            lv_label_set_text_fmt(id(lbl_pressure_value), "%d", pressure);

# I2C for touchscreen
i2c:
  sda: GPIO7
  scl: GPIO8
  scan: true
  frequency: 400kHz

# Display (MIPI DSI)
external_components:
  - source: github://pr#10562
    components: [mipi_dsi]
    refresh: 1h

display:
  - platform: mipi_dsi
    model: WAVESHARE-P4-86-PANEL
    id: main_display
    reset_pin:
      number: GPIO27
      inverted: false

# Touchscreen (GT911)
touchscreen:
  platform: gt911
  id: main_touch
  on_touch:
    # Reset inactivity counter on any touch
    - lambda: 'id(inactivity_seconds) = 0;'
  on_release:
    # Wake up screen if dimmed
    - if:
        condition: lvgl.is_paused
        then:
          - lvgl.resume:
          - light.turn_on: display_backlight
          - lambda: 'id(inactivity_seconds) = 0;'

# Backlight
output:
  - platform: ledc
    id: backlight_output
    pin: GPIO26
    frequency: 100Hz
    inverted: true
    max_power: 0.8

light:
  - platform: monochromatic
    name: "Backlight"
    output: backlight_output
    id: display_backlight
    restore_mode: ALWAYS_ON

# Global variables
globals:
  - id: power_value
    type: int
    initial_value: '0'
  - id: manual_mode_active
    type: bool
    initial_value: 'false'
  - id: temp_manual_mode_active
    type: bool
    initial_value: 'false'
  - id: boost_mode_active
    type: bool
    initial_value: 'false'
  - id: bypass_active
    type: bool
    initial_value: 'false'
  - id: ignore_slider_events
    type: bool
    initial_value: 'false'
  - id: inactivity_seconds
    type: int
    initial_value: '0'

# Colors
color:
  - id: color_bg
    hex: "1a1a2e"
  - id: color_card
    hex: "16213e"
  - id: color_accent
    hex: "0f3460"
  - id: color_text
    hex: "e8e8e8"
  - id: color_text_dim
    hex: "888888"
  - id: color_green
    hex: "00c853"
  - id: color_orange
    hex: "ff9800"
  - id: color_red
    hex: "f44336"
  - id: color_blue
    hex: "2196f3"

# LVGL UI
lvgl:
  id: lvgl_main
  buffer_size: 100%
  byte_order: little_endian
  touchscreens:
    - touchscreen_id: main_touch

  style_definitions:
    - id: style_card
      bg_color: 0x16213e
      radius: 12
      pad_all: 12
      border_width: 0

    - id: style_btn
      bg_color: 0x37474F
      radius: 8
      pad_all: 10
      text_color: 0xFFFFFF

  pages:
    # ==================== MAIN PAGE ====================
    - id: page_main
      bg_color: 0x1a1a2e
      widgets:
        # Header
        - label:
            align: TOP_MID
            y: 15
            text: "HRV Control"
            text_font: montserrat_24
            text_color: 0xe8e8e8

        # ========== POWER ARC (center top) ==========
        - obj:
            align: TOP_MID
            y: 50
            width: 200
            height: 200
            styles: style_card
            widgets:
              - arc:
                  id: arc_power
                  align: CENTER
                  width: 160
                  height: 160
                  min_value: 0
                  max_value: 100
                  value: 0
                  rotation: 135
                  end_angle: 270
                  arc_width: 15
                  indicator:
                    arc_width: 15
                    arc_color: 0x00c853
                  knob:
                    bg_opa: TRANSP
              - label:
                  id: lbl_power_value
                  align: CENTER
                  text: "0%"
                  text_font: montserrat_36
                  text_color: 0xFFFFFF
              - label:
                  align: CENTER
                  y: 35
                  text: "Power"
                  text_font: montserrat_14
                  text_color: 0x888888

        # ========== SENSOR CARDS (row below arc) ==========
        # Temperature
        - obj:
            x: 20
            y: 270
            width: 160
            height: 100
            styles: style_card
            widgets:
              - label:
                  align: TOP_LEFT
                  text: "Temperature"
                  text_font: montserrat_14
                  text_color: 0x888888
              - label:
                  id: lbl_temp_value
                  align: CENTER
                  y: 5
                  text: "--"
                  text_font: montserrat_36
                  text_color: 0xFFA500
              - label:
                  align: CENTER
                  y: 35
                  text: "C"
                  text_font: montserrat_14
                  text_color: 0x888888

        # Humidity
        - obj:
            x: 195
            y: 270
            width: 160
            height: 100
            styles: style_card
            widgets:
              - label:
                  align: TOP_LEFT
                  text: "Humidity"
                  text_font: montserrat_14
                  text_color: 0x888888
              - label:
                  id: lbl_humidity_value
                  align: CENTER
                  y: 5
                  text: "--"
                  text_font: montserrat_36
                  text_color: 0x2196F3
              - label:
                  align: CENTER
                  y: 35
                  text: "%"
                  text_font: montserrat_14
                  text_color: 0x888888

        # CO2
        - obj:
            x: 370
            y: 270
            width: 160
            height: 100
            styles: style_card
            widgets:
              - label:
                  align: TOP_LEFT
                  text: "CO2"
                  text_font: montserrat_14
                  text_color: 0x888888
              - label:
                  id: lbl_co2_value
                  align: CENTER
                  y: 5
                  text: "--"
                  text_font: montserrat_36
                  text_color: 0x00c853
              - label:
                  align: CENTER
                  y: 35
                  text: "ppm"
                  text_font: montserrat_14
                  text_color: 0x888888

        # Pressure
        - obj:
            x: 545
            y: 270
            width: 160
            height: 100
            styles: style_card
            widgets:
              - label:
                  align: TOP_LEFT
                  text: "Pressure"
                  text_font: montserrat_14
                  text_color: 0x888888
              - label:
                  id: lbl_pressure_value
                  align: CENTER
                  y: 5
                  text: "--"
                  text_font: montserrat_28
                  text_color: 0x888888
              - label:
                  align: CENTER
                  y: 30
                  text: "hPa"
                  text_font: montserrat_14
                  text_color: 0x888888

        # ========== SAFETY INDICATORS ==========
        # Smoke (green = OK, red = alarm)
        - obj:
            id: smoke_indicator
            x: 20
            y: 380
            width: 110
            height: 65
            bg_color: 0x00c853
            radius: 8
            widgets:
              - label:
                  align: CENTER
                  text: "Smoke"
                  text_font: montserrat_18
                  text_color: 0xFFFFFF

        # Gas (green = OK, red = alarm)
        - obj:
            id: gas_indicator
            x: 135
            y: 380
            width: 110
            height: 65
            bg_color: 0x00c853
            radius: 8
            widgets:
              - label:
                  align: CENTER
                  text: "Gas"
                  text_font: montserrat_18
                  text_color: 0xFFFFFF

        # ========== BYPASS TOGGLE ==========
        # (gray = off, blue = on)
        - button:
            id: btn_bypass
            x: 250
            y: 380
            width: 130
            height: 65
            bg_color: 0x37474F
            radius: 8
            widgets:
              - label:
                  align: CENTER
                  text: "Bypass"
                  text_font: montserrat_18
                  text_color: 0xFFFFFF
            on_click:
              then:
                - mqtt.publish:
                    topic: homehab/panel/command/bypass
                    payload: !lambda |-
                      return id(bypass_active) ? "OFF" : "ON";

        # ========== MANUAL POWER SLIDER (full width above buttons) ==========
        - obj:
            align: BOTTOM_MID
            y: -115
            width: 760
            height: 50
            styles: style_card
            widgets:
              - slider:
                  id: slider_manual_power
                  align: CENTER
                  width: 720
                  height: 35
                  min_value: 0
                  max_value: 100
                  value: 50
                  indicator:
                    bg_color: 0x2196F3
                  knob:
                    bg_color: 0xFFFFFF
                  on_release:
                    then:
                      - if:
                          condition:
                            lambda: 'return !id(ignore_slider_events);'
                          then:
                            - mqtt.publish:
                                topic: homehab/panel/command/manualPower
                                payload: !lambda |-
                                  return to_string((int)x);

        # ========== MODE BUTTONS ==========
        # Auto Mode Button - turns off all manual modes
        - button:
            id: btn_auto
            align: BOTTOM_LEFT
            x: 30
            y: -40
            width: 200
            height: 65
            bg_color: 0x00c853
            radius: 10
            widgets:
              - label:
                  align: CENTER
                  text: "AUTO"
                  text_font: montserrat_24
                  text_color: 0xFFFFFF
            on_click:
              then:
                # Turn off all manual modes
                - mqtt.publish:
                    topic: homehab/panel/command/manualMode
                    payload: "OFF"
                - mqtt.publish:
                    topic: homehab/panel/command/temporaryManualMode
                    payload: "OFF"
                - mqtt.publish:
                    topic: homehab/panel/command/temporaryBoostMode
                    payload: "OFF"

        # Boost Mode Button - activates temporaryBoostMode
        - button:
            id: btn_boost
            align: BOTTOM_MID
            y: -40
            width: 200
            height: 65
            bg_color: 0x37474F
            radius: 10
            widgets:
              - label:
                  align: CENTER
                  text: "BOOST"
                  text_font: montserrat_24
                  text_color: 0xFFFFFF
            on_click:
              then:
                - mqtt.publish:
                    topic: homehab/panel/command/temporaryBoostMode
                    payload: "ON"

        # Manual Mode Button - activates temporaryManualMode
        - button:
            id: btn_manual
            align: BOTTOM_RIGHT
            x: -30
            y: -40
            width: 200
            height: 65
            bg_color: 0x37474F
            radius: 10
            widgets:
              - label:
                  align: CENTER
                  text: "MANUAL"
                  text_font: montserrat_24
                  text_color: 0xFFFFFF
            on_click:
              then:
                - mqtt.publish:
                    topic: homehab/panel/command/temporaryManualMode
                    payload: "ON"

        # ========== FOOTER (IP address) ==========
        - label:
            id: lbl_ip
            align: BOTTOM_MID
            y: -10
            text: "Connecting..."
            text_font: montserrat_14
            text_color: 0x888888

# Sensors publishing to MQTT
sensor:
  - platform: uptime
    name: "Uptime"
    update_interval: 60s

text_sensor:
  - platform: ethernet_info
    ip_address:
      name: "IP Address"
      on_value:
        then:
          - lambda: |-
              lv_label_set_text(id(lbl_ip), x.c_str());

# Interval for screen auto-dim
interval:
  - interval: 1s
    then:
      - lambda: |-
          // Skip if timeout disabled
          int timeout = ${screen_timeout};
          if (timeout <= 0) return;
          id(inactivity_seconds)++;
      - if:
          condition:
            lambda: 'return id(inactivity_seconds) == ${screen_timeout} && ${screen_timeout} > 0;'
          then:
            - lambda: 'ESP_LOGI("panel", "Screen timeout - dimming display");'
            - light.turn_off: display_backlight
            - lvgl.pause:

# Scripts
script:
  # Update button colors based on current mode states
  - id: update_button_colors
    then:
      - lambda: |-
          ESP_LOGI("panel", "update_button_colors: manual=%d, temp_manual=%d, boost=%d",
                   id(manual_mode_active), id(temp_manual_mode_active), id(boost_mode_active));
          // AUTO button: green if no manual modes active
          bool auto_active = !id(manual_mode_active) && !id(temp_manual_mode_active) && !id(boost_mode_active);
          if (auto_active) {
            lv_obj_set_style_bg_color(id(btn_auto), lv_color_hex(0x00c853), 0);  // Green
          } else {
            lv_obj_set_style_bg_color(id(btn_auto), lv_color_hex(0x37474F), 0);  // Gray
          }

          // BOOST button: orange if temporaryBoostMode active
          if (id(boost_mode_active)) {
            lv_obj_set_style_bg_color(id(btn_boost), lv_color_hex(0xFF9800), 0);  // Orange
          } else {
            lv_obj_set_style_bg_color(id(btn_boost), lv_color_hex(0x37474F), 0);  // Gray
          }

          // MANUAL button: blue if temporaryManualMode active
          if (id(temp_manual_mode_active)) {
            lv_obj_set_style_bg_color(id(btn_manual), lv_color_hex(0x2196F3), 0);  // Blue
          } else {
            lv_obj_set_style_bg_color(id(btn_manual), lv_color_hex(0x37474F), 0);  // Gray
          }

  # Fetch initial states from OpenHAB REST API
  - id: fetch_initial_states
    then:
      - lambda: |-
          ESP_LOGI("panel", "Fetching initial states from OpenHAB...");
      # Fetch HRV Output Power
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/hrvOutputPower/state"
          capture_response: true
          on_response:
            - lambda: |-
                ESP_LOGI("panel", "HTTP hrvOutputPower: status=%d, body='%s'", response->status_code, body.c_str());
                if (response->status_code == 200) {
                  int power = atoi(body.c_str());
                  id(power_value) = power;
                  lv_arc_set_value(id(arc_power), power);
                  lv_label_set_text_fmt(id(lbl_power_value), "%d%%", power);
                }
          on_error:
            - lambda: |-
                ESP_LOGE("panel", "HTTP hrvOutputPower FAILED");
      # Fetch Temperature
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/temperature/state"
          capture_response: true
          on_response:
            - lambda: |-
                ESP_LOGI("panel", "HTTP temperature: status=%d, body='%s'", response->status_code, body.c_str());
                if (response->status_code == 200) {
                  float temp = atof(body.c_str());
                  int temp_int = (int)(temp * 10);
                  int whole = temp_int / 10;
                  int frac = temp_int % 10;
                  if (frac < 0) frac = -frac;
                  lv_label_set_text_fmt(id(lbl_temp_value), "%d.%d", whole, frac);
                }
          on_error:
            - lambda: |-
                ESP_LOGE("panel", "HTTP temperature FAILED");
      # Fetch Air Humidity
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/airHumidity/state"
          capture_response: true
          on_response:
            - lambda: |-
                ESP_LOGI("panel", "HTTP airHumidity: status=%d, body='%s'", response->status_code, body.c_str());
                if (response->status_code == 200) {
                  int hum = atoi(body.c_str());
                  lv_label_set_text_fmt(id(lbl_humidity_value), "%d", hum);
                }
          on_error:
            - lambda: |-
                ESP_LOGE("panel", "HTTP airHumidity FAILED");
      # Fetch CO2
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/co2/state"
          capture_response: true
          on_response:
            - lambda: |-
                ESP_LOGI("panel", "HTTP co2: status=%d, body='%s'", response->status_code, body.c_str());
                if (response->status_code == 200) {
                  int co2 = atoi(body.c_str());
                  lv_label_set_text_fmt(id(lbl_co2_value), "%d", co2);
                }
          on_error:
            - lambda: |-
                ESP_LOGE("panel", "HTTP co2 FAILED");
      # Fetch Pressure
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/pressure/state"
          capture_response: true
          on_response:
            - lambda: |-
                ESP_LOGI("panel", "HTTP pressure: status=%d, body='%s'", response->status_code, body.c_str());
                if (response->status_code == 200) {
                  int pressure = (int)(atof(body.c_str()) + 0.5);
                  lv_label_set_text_fmt(id(lbl_pressure_value), "%d", pressure);
                }
          on_error:
            - lambda: |-
                ESP_LOGE("panel", "HTTP pressure FAILED");
      # Fetch Manual Mode
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/manualMode/state"
          capture_response: true
          on_response:
            - lambda: |-
                ESP_LOGI("panel", "HTTP manualMode: status=%d, body='%s'", response->status_code, body.c_str());
                if (response->status_code == 200) {
                  id(manual_mode_active) = (body == "ON");
                }
          on_error:
            - lambda: |-
                ESP_LOGE("panel", "HTTP manualMode FAILED");
      # Fetch Temporary Manual Mode
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/temporaryManualMode/state"
          capture_response: true
          on_response:
            - lambda: |-
                ESP_LOGI("panel", "HTTP temporaryManualMode: status=%d, body='%s'", response->status_code, body.c_str());
                if (response->status_code == 200) {
                  id(temp_manual_mode_active) = (body == "ON");
                }
          on_error:
            - lambda: |-
                ESP_LOGE("panel", "HTTP temporaryManualMode FAILED");
      # Fetch Boost Mode
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/temporaryBoostMode/state"
          capture_response: true
          on_response:
            - lambda: |-
                ESP_LOGI("panel", "HTTP temporaryBoostMode: status=%d, body='%s'", response->status_code, body.c_str());
                if (response->status_code == 200) {
                  id(boost_mode_active) = (body == "ON");
                }
          on_error:
            - lambda: |-
                ESP_LOGE("panel", "HTTP temporaryBoostMode FAILED");
      # Fetch Bypass
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/bypass/state"
          capture_response: true
          on_response:
            - lambda: |-
                ESP_LOGI("panel", "HTTP bypass: status=%d, body='%s'", response->status_code, body.c_str());
                if (response->status_code == 200) {
                  id(bypass_active) = (body == "ON");
                  lv_obj_set_style_bg_color(id(btn_bypass),
                    id(bypass_active) ? lv_color_hex(0x2196F3) : lv_color_hex(0x37474F), 0);
                }
          on_error:
            - lambda: |-
                ESP_LOGE("panel", "HTTP bypass FAILED");
      # Update button colors after all states loaded
      - script.execute: update_button_colors
      - lambda: |-
          ESP_LOGI("panel", "Initial states fetched successfully");
