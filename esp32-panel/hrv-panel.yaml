# HRV Control Panel for OpenHAB - New Design
# ESP32-P4-86-Panel-ETH-2RO
# Screen: 720x720px

substitutions:
  name: hrv-panel
  friendly_name: HRV Control Panel
  screen_timeout: "60"

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  platformio_options:
    board_build.flash_mode: dio
  on_boot:
    priority: -100
    then:
      - delay: 5s
      - script.execute: fetch_initial_states

esp32:
  board: esp32-p4-evboard
  flash_size: 32MB
  cpu_frequency: 400MHz
  framework:
    type: esp-idf
    advanced:
      enable_idf_experimental_features: yes

logger:
  level: DEBUG
  hardware_uart: UART0

ota:
  platform: esphome

web_server:
  port: 80

psram:
  speed: 200MHz

esp_ldo:
  - channel: 3
    voltage: 2.5V

http_request:
  verify_ssl: false
  timeout: 10s

# Time sync
time:
  - platform: sntp
    id: sntp_time
    timezone: Europe/Prague
    servers:
      - 0.pool.ntp.org
      - 1.pool.ntp.org
    on_time_sync:
      - lambda: 'ESP_LOGI("panel", "Time synchronized");'

# Ethernet
ethernet:
  type: IP101
  mdc_pin: GPIO31
  mdio_pin: GPIO52
  clk:
    pin: GPIO50
    mode: CLK_EXT_IN
  phy_addr: 1
  power_pin: GPIO51

# MQTT
mqtt:
  broker: zigbee.home
  port: 1883
  topic_prefix: homehab/panel
  birth_message:
    topic: homehab/panel/status
    payload: online
  will_message:
    topic: homehab/panel/status
    payload: offline

  on_message:
    # HRV Output Power - display on slider
    - topic: homehab/state/hrvOutputPower
      then:
        - lambda: |-
            int power = atoi(x.c_str());
            id(power_value) = power;
            lv_bar_set_value(id(fan_bar), power, LV_ANIM_ON);
            lv_label_set_text_fmt(id(lbl_fan_value), "%d%%", power);

    # Manual Power - sync slider position
    - topic: homehab/state/manualPower
      then:
        - lambda: |-
            id(ignore_slider_events) = true;
            int power = atoi(x.c_str());
            id(manual_power_value) = power;
        - delay: 100ms
        - lambda: 'id(ignore_slider_events) = false;'

    # Inside Temperature
    - topic: homehab/state/temperature
      then:
        - lambda: |-
            float temp = atof(x.c_str());
            id(inside_temp) = temp;
            lv_label_set_text_fmt(id(lbl_indoor_value), "%.0f", temp);

    # Outside Temperature
    - topic: homehab/state/outsideTemperature
      then:
        - lambda: |-
            float temp = atof(x.c_str());
            id(outside_temp) = temp;
            lv_label_set_text_fmt(id(lbl_outdoor_value), "%.0f", temp);

    # Humidity
    - topic: homehab/state/airHumidity
      then:
        - lambda: |-
            int hum = atoi(x.c_str());
            lv_label_set_text_fmt(id(lbl_humidity_value), "%d", hum);

    # CO2
    - topic: homehab/state/co2
      then:
        - lambda: |-
            int co2 = atoi(x.c_str());
            lv_label_set_text_fmt(id(lbl_co2_value), "%d", co2);

    # Manual Mode
    - topic: homehab/state/manualMode
      then:
        - lambda: 'id(manual_mode_active) = (x == "ON");'
        - script.execute: update_mode_buttons

    # Temporary Manual Mode
    - topic: homehab/state/temporaryManualMode
      then:
        - lambda: 'id(temp_manual_mode_active) = (x == "ON");'
        - script.execute: update_mode_buttons

    # Boost Mode
    - topic: homehab/state/temporaryBoostMode
      then:
        - lambda: 'id(boost_mode_active) = (x == "ON");'
        - script.execute: update_mode_buttons

    # Bypass
    - topic: homehab/state/bypass
      then:
        - lambda: |-
            id(bypass_active) = (x == "ON");
            // Update toggle visual
            lv_obj_set_style_bg_color(id(bypass_toggle),
              id(bypass_active) ? lv_color_hex(0x00d68f) : lv_color_hex(0x1a2332), 0);
            // Move toggle knob
            lv_obj_set_x(id(bypass_knob), id(bypass_active) ? 32 : 4);
            lv_obj_set_style_bg_color(id(bypass_knob),
              id(bypass_active) ? lv_color_hex(0xFFFFFF) : lv_color_hex(0x8892a4), 0);

    # Smoke
    - topic: homehab/state/smoke
      then:
        - lambda: 'id(smoke_alarm) = (x == "ON");'
        - script.execute: update_alerts

    # Gas
    - topic: homehab/state/gas
      then:
        - lambda: 'id(gas_alarm) = (x == "ON");'
        - script.execute: update_alerts

    # Filter
    - topic: homehab/state/filterCleaningRequired
      then:
        - lambda: 'id(filter_cleaning_required) = (x == "ON");'
        - script.execute: update_alerts

# I2C for touchscreen
i2c:
  sda: GPIO7
  scl: GPIO8
  scan: true
  frequency: 400kHz

# Display
external_components:
  - source: github://pr#10562
    components: [mipi_dsi]
    refresh: 1h

display:
  - platform: mipi_dsi
    model: WAVESHARE-P4-86-PANEL
    id: main_display
    reset_pin:
      number: GPIO27
      inverted: false

# Touchscreen
touchscreen:
  platform: gt911
  id: main_touch
  on_touch:
    - lambda: 'id(inactivity_seconds) = 0;'
  on_release:
    - if:
        condition:
          lambda: 'return id(screen_off);'
        then:
          - lvgl.resume:
          - light.turn_on: display_backlight
          - lambda: |-
              id(inactivity_seconds) = 0;
              id(screen_off) = false;

# Backlight
output:
  - platform: ledc
    id: backlight_output
    pin: GPIO26
    frequency: 100Hz
    inverted: true
    max_power: 0.8

light:
  - platform: monochromatic
    name: "Backlight"
    output: backlight_output
    id: display_backlight
    restore_mode: ALWAYS_ON

# Global variables
globals:
  - id: power_value
    type: int
    initial_value: '0'
  - id: manual_power_value
    type: int
    initial_value: '50'
  - id: inside_temp
    type: float
    initial_value: '0'
  - id: outside_temp
    type: float
    initial_value: '0'
  - id: manual_mode_active
    type: bool
    initial_value: 'false'
  - id: temp_manual_mode_active
    type: bool
    initial_value: 'false'
  - id: boost_mode_active
    type: bool
    initial_value: 'false'
  - id: bypass_active
    type: bool
    initial_value: 'false'
  - id: smoke_alarm
    type: bool
    initial_value: 'false'
  - id: gas_alarm
    type: bool
    initial_value: 'false'
  - id: filter_cleaning_required
    type: bool
    initial_value: 'false'
  - id: network_connected
    type: bool
    initial_value: 'false'
  - id: ignore_slider_events
    type: bool
    initial_value: 'false'
  - id: inactivity_seconds
    type: int
    initial_value: '0'
  - id: screen_off
    type: bool
    initial_value: 'false'

# LVGL UI - New Design
lvgl:
  id: lvgl_main
  buffer_size: 100%
  byte_order: little_endian
  touchscreens:
    - touchscreen_id: main_touch

  style_definitions:
    - id: style_card
      bg_color: 0x151c25
      radius: 24
      pad_all: 24
      border_width: 1
      border_color: 0x1f2937

  pages:
    - id: page_main
      bg_color: 0x0a0e14
      widgets:
        # ==================== HEADER ====================
        # Time (large)
        - label:
            id: lbl_time
            x: 28
            y: 20
            text: "00:00"
            text_font: montserrat_48
            text_color: 0x4facfe

        # Date
        - label:
            id: lbl_date
            x: 200
            y: 42
            text: "PO 1. LEDNA"
            text_font: montserrat_14
            text_color: 0x8892a4

        # Mode selector background
        - obj:
            x: 380
            y: 20
            width: 260
            height: 48
            bg_color: 0x151c25
            radius: 14
            border_width: 1
            border_color: 0x1f2937
            widgets:
              # VYP button
              - button:
                  id: btn_off
                  x: 4
                  y: 4
                  width: 58
                  height: 40
                  bg_color: 0x151c25
                  radius: 10
                  widgets:
                    - label:
                        align: CENTER
                        text: "VYP"
                        text_font: montserrat_12
                        text_color: 0x5a6578
                  on_click:
                    - mqtt.publish:
                        topic: homehab/panel/command/manualMode
                        payload: "ON"
                    - mqtt.publish:
                        topic: homehab/panel/command/manualPower
                        payload: "0"

              # MAN button
              - button:
                  id: btn_man
                  x: 66
                  y: 4
                  width: 58
                  height: 40
                  bg_color: 0x151c25
                  radius: 10
                  widgets:
                    - label:
                        align: CENTER
                        text: "MAN"
                        text_font: montserrat_12
                        text_color: 0x5a6578
                  on_click:
                    - mqtt.publish:
                        topic: homehab/panel/command/temporaryManualMode
                        payload: "ON"

              # BOOST button
              - button:
                  id: btn_boost
                  x: 128
                  y: 4
                  width: 58
                  height: 40
                  bg_color: 0x151c25
                  radius: 10
                  widgets:
                    - label:
                        align: CENTER
                        text: "BOOST"
                        text_font: montserrat_12
                        text_color: 0x5a6578
                  on_click:
                    - mqtt.publish:
                        topic: homehab/panel/command/temporaryBoostMode
                        payload: "ON"

              # AUTO button
              - button:
                  id: btn_auto
                  x: 190
                  y: 4
                  width: 62
                  height: 40
                  bg_color: 0x00d68f
                  radius: 10
                  widgets:
                    - label:
                        align: CENTER
                        text: "AUTO"
                        text_font: montserrat_12
                        text_color: 0xFFFFFF
                  on_click:
                    - mqtt.publish:
                        topic: homehab/panel/command/manualMode
                        payload: "OFF"
                    - mqtt.publish:
                        topic: homehab/panel/command/temporaryManualMode
                        payload: "OFF"
                    - mqtt.publish:
                        topic: homehab/panel/command/temporaryBoostMode
                        payload: "OFF"

        # Network indicator
        - obj:
            id: network_indicator
            x: 652
            y: 20
            width: 48
            height: 48
            bg_color: 0x112233
            radius: 12
            border_width: 1
            border_color: 0x4facfe33
            widgets:
              - label:
                  id: lbl_network_icon
                  align: CENTER
                  text: "W"
                  text_font: montserrat_24
                  text_color: 0x4facfe

        # Header separator line
        - obj:
            x: 28
            y: 82
            width: 664
            height: 1
            bg_color: 0x1f2937

        # ==================== STATS GRID (2x2) ====================
        # Outdoor Temperature (top left)
        - obj:
            x: 28
            y: 100
            width: 322
            height: 150
            styles: style_card
            widgets:
              # Top colored bar
              - obj:
                  x: 0
                  y: -24
                  width: 322
                  height: 4
                  bg_color: 0x4facfe
                  radius: 2
              # Icon + Label row
              - obj:
                  x: 0
                  y: 0
                  width: 40
                  height: 40
                  bg_color: 0x4facfe26
                  radius: 12
                  widgets:
                    - label:
                        align: CENTER
                        text: "O"
                        text_font: montserrat_18
                        text_color: 0x00f2fe
              - label:
                  x: 52
                  y: 10
                  text: "VENKOVNI"
                  text_font: montserrat_14
                  text_color: 0x8892a4
              # Value
              - label:
                  id: lbl_outdoor_value
                  x: 0
                  y: 60
                  text: "--"
                  text_font: montserrat_48
                  text_color: 0x00f2fe
              - label:
                  x: 100
                  y: 70
                  text: "°C"
                  text_font: montserrat_24
                  text_color: 0x8892a4

        # Indoor Temperature (top right)
        - obj:
            x: 370
            y: 100
            width: 322
            height: 150
            styles: style_card
            widgets:
              - obj:
                  x: 0
                  y: -24
                  width: 322
                  height: 4
                  bg_color: 0x00d68f
                  radius: 2
              - obj:
                  x: 0
                  y: 0
                  width: 40
                  height: 40
                  bg_color: 0x00d68f26
                  radius: 12
                  widgets:
                    - label:
                        align: CENTER
                        text: "#"
                        text_font: montserrat_18
                        text_color: 0x00d68f
              - label:
                  x: 52
                  y: 10
                  text: "VNITRNI"
                  text_font: montserrat_14
                  text_color: 0x8892a4
              - label:
                  id: lbl_indoor_value
                  x: 0
                  y: 60
                  text: "--"
                  text_font: montserrat_48
                  text_color: 0x00d68f
              - label:
                  x: 100
                  y: 70
                  text: "°C"
                  text_font: montserrat_24
                  text_color: 0x8892a4

        # Humidity (bottom left)
        - obj:
            x: 28
            y: 268
            width: 322
            height: 150
            styles: style_card
            widgets:
              - obj:
                  x: 0
                  y: -24
                  width: 322
                  height: 4
                  bg_color: 0xa78bfa
                  radius: 2
              - obj:
                  x: 0
                  y: 0
                  width: 40
                  height: 40
                  bg_color: 0xa78bfa26
                  radius: 12
                  widgets:
                    - label:
                        align: CENTER
                        text: "~"
                        text_font: montserrat_18
                        text_color: 0xa78bfa
              - label:
                  x: 52
                  y: 10
                  text: "VLHKOST"
                  text_font: montserrat_14
                  text_color: 0x8892a4
              - label:
                  id: lbl_humidity_value
                  x: 0
                  y: 60
                  text: "--"
                  text_font: montserrat_48
                  text_color: 0xa78bfa
              - label:
                  x: 100
                  y: 70
                  text: "%"
                  text_font: montserrat_24
                  text_color: 0x8892a4

        # CO2 (bottom right)
        - obj:
            x: 370
            y: 268
            width: 322
            height: 150
            styles: style_card
            widgets:
              - obj:
                  x: 0
                  y: -24
                  width: 322
                  height: 4
                  bg_color: 0xff9f43
                  radius: 2
              - obj:
                  x: 0
                  y: 0
                  width: 40
                  height: 40
                  bg_color: 0xff9f4326
                  radius: 12
                  widgets:
                    - label:
                        align: CENTER
                        text: "o"
                        text_font: montserrat_18
                        text_color: 0xff9f43
              - label:
                  x: 52
                  y: 10
                  text: "CO2"
                  text_font: montserrat_14
                  text_color: 0x8892a4
              - label:
                  id: lbl_co2_value
                  x: 0
                  y: 60
                  text: "--"
                  text_font: montserrat_48
                  text_color: 0xff9f43
              - label:
                  x: 150
                  y: 70
                  text: "ppm"
                  text_font: montserrat_24
                  text_color: 0x8892a4

        # ==================== FAN SPEED SECTION ====================
        - obj:
            x: 28
            y: 436
            width: 664
            height: 110
            styles: style_card
            widgets:
              # Icon
              - obj:
                  x: 0
                  y: 8
                  width: 40
                  height: 40
                  bg_color: 0x4facfe26
                  radius: 12
                  widgets:
                    - label:
                        id: lbl_fan_icon
                        align: CENTER
                        text: "@"
                        text_font: montserrat_18
                        text_color: 0x4facfe
              # Label
              - label:
                  x: 52
                  y: 18
                  text: "RYCHLOST VENTILATORU"
                  text_font: montserrat_14
                  text_color: 0x8892a4
              # Value
              - label:
                  id: lbl_fan_value
                  align: TOP_RIGHT
                  y: 8
                  text: "0%"
                  text_font: montserrat_36
                  text_color: 0x4facfe
              # Progress bar (clickable)
              - obj:
                  id: fan_bar_container
                  x: 0
                  y: 58
                  width: 616
                  height: 20
                  bg_color: 0x4facfe1a
                  radius: 10
                  widgets:
                    - bar:
                        id: fan_bar
                        align: LEFT_MID
                        x: 0
                        y: 0
                        width: 616
                        height: 20
                        min_value: 0
                        max_value: 100
                        value: 0
                        indicator:
                          bg_color: 0x4facfe
                          radius: 10
                  on_click:
                    then:
                      - mqtt.publish:
                          topic: homehab/panel/command/manualPower
                          payload: !lambda |-
                            if (id(ignore_slider_events)) return std::string("0");
                            lv_point_t point;
                            lv_indev_get_point(lv_indev_get_act(), &point);
                            int power = ((point.x - 56) * 100) / 616;
                            if (power < 0) power = 0;
                            if (power > 100) power = 100;
                            ESP_LOGI("panel", "Fan bar clicked: power=%d", power);
                            return to_string(power);

        # ==================== BOTTOM ROW ====================
        # Bypass Toggle (left)
        - obj:
            x: 28
            y: 564
            width: 322
            height: 80
            styles: style_card
            on_click:
              - mqtt.publish:
                  topic: homehab/panel/command/bypass
                  payload: !lambda 'return id(bypass_active) ? "OFF" : "ON";'
            widgets:
              # Icon
              - obj:
                  x: 0
                  y: 8
                  width: 44
                  height: 44
                  bg_color: 0x00d68f1a
                  radius: 14
                  widgets:
                    - label:
                        align: CENTER
                        text: "<>"
                        text_font: montserrat_20
                        text_color: 0x00d68f
              # Label
              - label:
                  x: 58
                  y: 18
                  text: "BYPASS"
                  text_font: montserrat_14
                  text_color: 0x8892a4
              # Toggle switch
              - obj:
                  id: bypass_toggle
                  align: RIGHT_MID
                  x: -10
                  width: 60
                  height: 32
                  bg_color: 0x1a2332
                  radius: 16
                  widgets:
                    - obj:
                        id: bypass_knob
                        x: 4
                        y: 4
                        width: 24
                        height: 24
                        bg_color: 0x8892a4
                        radius: 12

        # Alert Area (right)
        - obj:
            id: alert_area
            x: 370
            y: 564
            width: 322
            height: 80
            styles: style_card
            bg_color: 0x151c25
            widgets:
              - label:
                  id: lbl_alert_icon
                  x: 10
                  y: 16
                  text: ""
                  text_font: montserrat_28
                  text_color: 0x5a6578
              - label:
                  id: lbl_alert_text
                  align: CENTER
                  text: "Zadna upozorneni"
                  text_font: montserrat_14
                  text_color: 0x5a6578

# Sensors
sensor:
  - platform: uptime
    name: "Uptime"
    update_interval: 60s

binary_sensor:
  - platform: status
    name: "Status"
    id: device_status
    on_state:
      - lambda: 'id(network_connected) = x;'
      - script.execute: update_network_indicator

text_sensor:
  - platform: ethernet_info
    ip_address:
      name: "IP Address"

# Intervals
interval:
  # Update time display every second
  - interval: 1s
    then:
      - lambda: |-
          auto time = id(sntp_time).now();
          if (time.is_valid()) {
            lv_label_set_text_fmt(id(lbl_time), "%02d:%02d", time.hour, time.minute);

            // Czech day names
            const char* days[] = {"NE", "PO", "UT", "ST", "CT", "PA", "SO"};
            const char* months[] = {"LEDNA", "UNORA", "BREZNA", "DUBNA", "KVETNA", "CERVNA",
                                    "CERVENCE", "SRPNA", "ZARI", "RIJNA", "LISTOPADU", "PROSINCE"};
            int dow = time.day_of_week - 1;  // 1=Sunday in ESPHome
            if (dow < 0) dow = 6;
            lv_label_set_text_fmt(id(lbl_date), "%s %d. %s", days[dow], time.day_of_month, months[time.month - 1]);
          }

          // Screen timeout
          int timeout = ${screen_timeout};
          if (timeout > 0) {
            id(inactivity_seconds)++;
          }
      - if:
          condition:
            lambda: 'return id(inactivity_seconds) >= ${screen_timeout} && !id(screen_off);'
          then:
            - lambda: 'id(screen_off) = true;'
            - light.turn_off: display_backlight
            - lvgl.pause:

# Scripts
script:
  - id: update_mode_buttons
    then:
      - lambda: |-
          // Determine active mode
          bool off_mode = id(manual_mode_active) && (id(manual_power_value) == 0);
          bool manual_mode = id(temp_manual_mode_active);
          bool boost_mode = id(boost_mode_active);
          bool auto_mode = !id(manual_mode_active) && !id(temp_manual_mode_active) && !id(boost_mode_active);

          // VYP button
          lv_obj_set_style_bg_color(id(btn_off),
            off_mode ? lv_color_hex(0x5a6578) : lv_color_hex(0x151c25), 0);

          // MAN button
          lv_obj_set_style_bg_color(id(btn_man),
            manual_mode ? lv_color_hex(0x4facfe) : lv_color_hex(0x151c25), 0);

          // BOOST button
          lv_obj_set_style_bg_color(id(btn_boost),
            boost_mode ? lv_color_hex(0xff9f43) : lv_color_hex(0x151c25), 0);

          // AUTO button
          lv_obj_set_style_bg_color(id(btn_auto),
            auto_mode ? lv_color_hex(0x00d68f) : lv_color_hex(0x151c25), 0);

  - id: update_network_indicator
    then:
      - lambda: |-
          if (id(network_connected)) {
            lv_obj_set_style_bg_color(id(network_indicator), lv_color_hex(0x4facfe1a), 0);
            lv_obj_set_style_border_color(id(network_indicator), lv_color_hex(0x4facfe33), 0);
            lv_obj_set_style_text_color(id(lbl_network_icon), lv_color_hex(0x4facfe), 0);
          } else {
            lv_obj_set_style_bg_color(id(network_indicator), lv_color_hex(0xff6b6b1a), 0);
            lv_obj_set_style_border_color(id(network_indicator), lv_color_hex(0xff6b6b33), 0);
            lv_obj_set_style_text_color(id(lbl_network_icon), lv_color_hex(0xff6b6b), 0);
          }

  - id: update_alerts
    then:
      - lambda: |-
          // Priority: gas > smoke > filter
          if (id(gas_alarm)) {
            lv_obj_set_style_bg_color(id(alert_area), lv_color_hex(0xff6b6b14), 0);
            lv_obj_set_style_border_color(id(alert_area), lv_color_hex(0xff6b6b40), 0);
            lv_label_set_text(id(lbl_alert_icon), "!!");
            lv_obj_set_style_text_color(id(lbl_alert_icon), lv_color_hex(0xff6b6b), 0);
            lv_label_set_text(id(lbl_alert_text), "UNIK PLYNU!");
            lv_obj_set_style_text_color(id(lbl_alert_text), lv_color_hex(0xff6b6b), 0);
          } else if (id(smoke_alarm)) {
            lv_obj_set_style_bg_color(id(alert_area), lv_color_hex(0xff6b6b14), 0);
            lv_obj_set_style_border_color(id(alert_area), lv_color_hex(0xff6b6b40), 0);
            lv_label_set_text(id(lbl_alert_icon), "^");
            lv_obj_set_style_text_color(id(lbl_alert_icon), lv_color_hex(0xff6b6b), 0);
            lv_label_set_text(id(lbl_alert_text), "DETEKCE KOURE!");
            lv_obj_set_style_text_color(id(lbl_alert_text), lv_color_hex(0xff6b6b), 0);
          } else if (id(filter_cleaning_required)) {
            lv_obj_set_style_bg_color(id(alert_area), lv_color_hex(0xff9f4314), 0);
            lv_obj_set_style_border_color(id(alert_area), lv_color_hex(0xff9f4340), 0);
            lv_label_set_text(id(lbl_alert_icon), "[]");
            lv_obj_set_style_text_color(id(lbl_alert_icon), lv_color_hex(0xff9f43), 0);
            lv_label_set_text(id(lbl_alert_text), "Vycistete filtr");
            lv_obj_set_style_text_color(id(lbl_alert_text), lv_color_hex(0xff9f43), 0);
          } else {
            lv_obj_set_style_bg_color(id(alert_area), lv_color_hex(0x151c25), 0);
            lv_obj_set_style_border_color(id(alert_area), lv_color_hex(0x1f2937), 0);
            lv_label_set_text(id(lbl_alert_icon), "");
            lv_label_set_text(id(lbl_alert_text), "Zadna upozorneni");
            lv_obj_set_style_text_color(id(lbl_alert_text), lv_color_hex(0x5a6578), 0);
          }

  - id: fetch_initial_states
    then:
      - lambda: 'ESP_LOGI("panel", "Fetching initial states...");'
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/hrvOutputPower/state"
          capture_response: true
          on_response:
            - lambda: |-
                if (response->status_code == 200) {
                  int power = atoi(body.c_str());
                  id(power_value) = power;
                  lv_bar_set_value(id(fan_bar), power, LV_ANIM_OFF);
                  lv_label_set_text_fmt(id(lbl_fan_value), "%d%%", power);
                }
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/insideTemperature/state"
          capture_response: true
          on_response:
            - lambda: |-
                if (response->status_code == 200) {
                  float temp = atof(body.c_str());
                  id(inside_temp) = temp;
                  lv_label_set_text_fmt(id(lbl_indoor_value), "%.0f", temp);
                }
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/outsideTemperature/state"
          capture_response: true
          on_response:
            - lambda: |-
                if (response->status_code == 200) {
                  float temp = atof(body.c_str());
                  id(outside_temp) = temp;
                  lv_label_set_text_fmt(id(lbl_outdoor_value), "%.0f", temp);
                }
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/airHumidity/state"
          capture_response: true
          on_response:
            - lambda: |-
                if (response->status_code == 200) {
                  int hum = atoi(body.c_str());
                  lv_label_set_text_fmt(id(lbl_humidity_value), "%d", hum);
                }
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/co2/state"
          capture_response: true
          on_response:
            - lambda: |-
                if (response->status_code == 200) {
                  int co2 = atoi(body.c_str());
                  lv_label_set_text_fmt(id(lbl_co2_value), "%d", co2);
                }
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/manualMode/state"
          capture_response: true
          on_response:
            - lambda: 'if (response->status_code == 200) id(manual_mode_active) = (body == "ON");'
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/temporaryManualMode/state"
          capture_response: true
          on_response:
            - lambda: 'if (response->status_code == 200) id(temp_manual_mode_active) = (body == "ON");'
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/temporaryBoostMode/state"
          capture_response: true
          on_response:
            - lambda: 'if (response->status_code == 200) id(boost_mode_active) = (body == "ON");'
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/bypass/state"
          capture_response: true
          on_response:
            - lambda: |-
                if (response->status_code == 200) {
                  id(bypass_active) = (body == "ON");
                  lv_obj_set_style_bg_color(id(bypass_toggle),
                    id(bypass_active) ? lv_color_hex(0x00d68f) : lv_color_hex(0x1a2332), 0);
                  lv_obj_set_x(id(bypass_knob), id(bypass_active) ? 32 : 4);
                  lv_obj_set_style_bg_color(id(bypass_knob),
                    id(bypass_active) ? lv_color_hex(0xFFFFFF) : lv_color_hex(0x8892a4), 0);
                }
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/smoke/state"
          capture_response: true
          on_response:
            - lambda: 'if (response->status_code == 200) id(smoke_alarm) = (body == "ON");'
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/gas/state"
          capture_response: true
          on_response:
            - lambda: 'if (response->status_code == 200) id(gas_alarm) = (body == "ON");'
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/filterCleaningRequired/state"
          capture_response: true
          on_response:
            - lambda: 'if (response->status_code == 200) id(filter_cleaning_required) = (body == "ON");'
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/manualPower/state"
          capture_response: true
          on_response:
            - lambda: 'if (response->status_code == 200) id(manual_power_value) = atoi(body.c_str());'
      - script.execute: update_mode_buttons
      - script.execute: update_alerts
      - script.execute: update_network_indicator
      - lambda: 'ESP_LOGI("panel", "Initial states loaded");'
