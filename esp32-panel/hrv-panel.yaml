# HRV Control Panel - Simplified Design
# ESP32-P4-86-Panel-ETH-2RO
# Screen: 720x720px

substitutions:
  name: hrv-panel
  friendly_name: HRV Control Panel
  screen_timeout: "60"

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  platformio_options:
    board_build.flash_mode: dio
  on_boot:
    priority: -100
    then:
      - delay: 5s
      - script.execute: fetch_initial_states

esp32:
  board: esp32-p4-evboard
  flash_size: 32MB
  cpu_frequency: 400MHz
  framework:
    type: esp-idf
    advanced:
      enable_idf_experimental_features: yes

logger:
  level: DEBUG
  hardware_uart: UART0

ota:
  platform: esphome

web_server:
  port: 80

psram:
  speed: 200MHz

esp_ldo:
  - channel: 3
    voltage: 2.5V

http_request:
  verify_ssl: false
  timeout: 10s

# Custom font with WiFi icon
font:
  - file: "gfonts://Material+Symbols+Outlined"
    id: wifi_icon_font
    size: 32
    glyphs:
      - "\U0000e63e"  # wifi

# Time sync
time:
  - platform: sntp
    id: sntp_time
    timezone: Europe/Prague
    servers:
      - 0.pool.ntp.org
      - 1.pool.ntp.org
    on_time_sync:
      - lambda: 'ESP_LOGI("panel", "Time synchronized");'

# Ethernet
ethernet:
  type: IP101
  mdc_pin: GPIO31
  mdio_pin: GPIO52
  clk:
    pin: GPIO50
    mode: CLK_EXT_IN
  phy_addr: 1
  power_pin: GPIO51

# MQTT
mqtt:
  broker: zigbee.home
  port: 1883
  topic_prefix: homehab/panel
  birth_message:
    topic: homehab/panel/status
    payload: online
  will_message:
    topic: homehab/panel/status
    payload: offline

  on_message:
    # HRV Output Power
    - topic: homehab/state/hrvOutputPower
      then:
        - lambda: |-
            int power = atoi(x.c_str());
            id(power_value) = power;
            lv_bar_set_value(id(fan_bar), power, LV_ANIM_ON);
            lv_label_set_text_fmt(id(lbl_fan_value), "%d%%", power);

    # Manual Power
    - topic: homehab/state/manualPower
      then:
        - lambda: |-
            id(ignore_slider_events) = true;
            id(manual_power_value) = atoi(x.c_str());
        - delay: 100ms
        - lambda: 'id(ignore_slider_events) = false;'

    # Inside Temperature
    - topic: homehab/state/temperature
      then:
        - lambda: |-
            int temp = (int)atof(x.c_str());
            id(inside_temp) = temp;
            lv_label_set_text_fmt(id(lbl_indoor_value), "%d", temp);

    # Outside Temperature
    - topic: homehab/state/outsideTemperature
      then:
        - lambda: |-
            int temp = (int)atof(x.c_str());
            id(outside_temp) = temp;
            lv_label_set_text_fmt(id(lbl_outdoor_value), "%d", temp);

    # Humidity
    - topic: homehab/state/airHumidity
      then:
        - lambda: 'lv_label_set_text_fmt(id(lbl_humidity_value), "%d", atoi(x.c_str()));'

    # CO2
    - topic: homehab/state/co2
      then:
        - lambda: 'lv_label_set_text_fmt(id(lbl_co2_value), "%d", atoi(x.c_str()));'

    # Manual Mode
    - topic: homehab/state/manualMode
      then:
        - lambda: 'id(manual_mode_active) = (x == "ON");'
        - script.execute: update_mode_buttons

    # Temporary Manual Mode
    - topic: homehab/state/temporaryManualMode
      then:
        - lambda: 'id(temp_manual_mode_active) = (x == "ON");'
        - script.execute: update_mode_buttons

    # Boost Mode
    - topic: homehab/state/temporaryBoostMode
      then:
        - lambda: 'id(boost_mode_active) = (x == "ON");'
        - script.execute: update_mode_buttons

    # Bypass
    - topic: homehab/state/bypass
      then:
        - lambda: |-
            id(bypass_active) = (x == "ON");
        - script.execute: update_bypass_visual

    # Smoke
    - topic: homehab/state/smoke
      then:
        - lambda: 'id(smoke_alarm) = (x == "ON");'
        - script.execute: update_alerts

    # Gas
    - topic: homehab/state/gas
      then:
        - lambda: 'id(gas_alarm) = (x == "ON");'
        - script.execute: update_alerts

    # Filter
    - topic: homehab/state/filterCleaningRequired
      then:
        - lambda: 'id(filter_cleaning_required) = (x == "ON");'
        - script.execute: update_alerts

# I2C for touchscreen
i2c:
  sda: GPIO7
  scl: GPIO8
  scan: true
  frequency: 400kHz

# Display
external_components:
  - source: github://pr#10562
    components: [mipi_dsi]
    refresh: 1h

display:
  - platform: mipi_dsi
    model: WAVESHARE-P4-86-PANEL
    id: main_display
    reset_pin:
      number: GPIO27
      inverted: false

# Touchscreen
touchscreen:
  platform: gt911
  id: main_touch
  on_touch:
    - lambda: 'id(inactivity_seconds) = 0;'
  on_release:
    - if:
        condition:
          lambda: 'return id(screen_off);'
        then:
          - lvgl.resume:
          - light.turn_on: display_backlight
          - lambda: |-
              id(inactivity_seconds) = 0;
              id(screen_off) = false;

# Backlight
output:
  - platform: ledc
    id: backlight_output
    pin: GPIO26
    frequency: 100Hz
    inverted: true
    max_power: 0.8

light:
  - platform: monochromatic
    name: "Backlight"
    output: backlight_output
    id: display_backlight
    restore_mode: ALWAYS_ON

# Global variables
globals:
  - id: power_value
    type: int
    initial_value: '0'
  - id: manual_power_value
    type: int
    initial_value: '50'
  - id: inside_temp
    type: float
    initial_value: '0'
  - id: outside_temp
    type: float
    initial_value: '0'
  - id: manual_mode_active
    type: bool
    initial_value: 'false'
  - id: temp_manual_mode_active
    type: bool
    initial_value: 'false'
  - id: boost_mode_active
    type: bool
    initial_value: 'false'
  - id: bypass_active
    type: bool
    initial_value: 'false'
  - id: smoke_alarm
    type: bool
    initial_value: 'false'
  - id: gas_alarm
    type: bool
    initial_value: 'false'
  - id: filter_cleaning_required
    type: bool
    initial_value: 'false'
  - id: network_connected
    type: bool
    initial_value: 'false'
  - id: ignore_slider_events
    type: bool
    initial_value: 'false'
  - id: inactivity_seconds
    type: int
    initial_value: '0'
  - id: screen_off
    type: bool
    initial_value: 'false'

# LVGL UI - Simplified Design
lvgl:
  id: lvgl_main
  buffer_size: 100%
  byte_order: little_endian
  touchscreens:
    - touchscreen_id: main_touch

  pages:
    - id: page_main
      bg_color: 0x1a1a2e
      widgets:
        # ==================== HEADER ====================
        # Time
        - label:
            id: lbl_time
            x: 24
            y: 20
            text: "00:00"
            text_font: montserrat_48
            text_color: 0xFFFFFF

        # Date
        - label:
            id: lbl_date
            x: 24
            y: 72
            text: "Pondeli 1. ledna"
            text_font: montserrat_16
            text_color: 0xa0a0b0

        # Mode buttons container
        - obj:
            x: 340
            y: 24
            width: 310
            height: 48
            bg_opa: TRANSP
            border_width: 0
            pad_all: 0
            widgets:
              # VYP
              - button:
                  id: btn_off
                  x: 0
                  y: 0
                  width: 64
                  height: 44
                  bg_color: 0x252542
                  radius: 12
                  widgets:
                    - label:
                        align: CENTER
                        text: "VYP"
                        text_font: montserrat_14
                        text_color: 0xa0a0b0
                  on_click:
                    - mqtt.publish:
                        topic: homehab/panel/command/manualMode
                        payload: "ON"
                    - mqtt.publish:
                        topic: homehab/panel/command/manualPower
                        payload: "0"

              # MAN
              - button:
                  id: btn_man
                  x: 72
                  y: 0
                  width: 64
                  height: 44
                  bg_color: 0x252542
                  radius: 12
                  widgets:
                    - label:
                        align: CENTER
                        text: "MAN"
                        text_font: montserrat_14
                        text_color: 0xa0a0b0
                  on_click:
                    - mqtt.publish:
                        topic: homehab/panel/command/temporaryManualMode
                        payload: "ON"

              # BOOST
              - button:
                  id: btn_boost
                  x: 144
                  y: 0
                  width: 72
                  height: 44
                  bg_color: 0x252542
                  radius: 12
                  widgets:
                    - label:
                        align: CENTER
                        text: "BOOST"
                        text_font: montserrat_14
                        text_color: 0xa0a0b0
                  on_click:
                    - mqtt.publish:
                        topic: homehab/panel/command/temporaryBoostMode
                        payload: "ON"

              # AUTO
              - button:
                  id: btn_auto
                  x: 224
                  y: 0
                  width: 64
                  height: 44
                  bg_color: 0x06d6a0
                  radius: 12
                  widgets:
                    - label:
                        id: lbl_auto
                        align: CENTER
                        text: "AUTO"
                        text_font: montserrat_14
                        text_color: 0x1a1a2e
                  on_click:
                    - mqtt.publish:
                        topic: homehab/panel/command/manualMode
                        payload: "OFF"
                    - mqtt.publish:
                        topic: homehab/panel/command/temporaryManualMode
                        payload: "OFF"
                    - mqtt.publish:
                        topic: homehab/panel/command/temporaryBoostMode
                        payload: "OFF"

        # Network indicator (just icon, no box)
        - label:
            id: lbl_network_icon
            x: 665
            y: 32
            text: "\U0000e63e"
            text_font: wifi_icon_font
            text_color: 0x4cc9f0

        # ==================== STATS GRID (2x2) ====================
        # Outdoor Temperature (top left)
        - obj:
            x: 24
            y: 110
            width: 330
            height: 120
            bg_color: 0x252542
            radius: 20
            border_width: 6
            border_color: 0x4cc9f0
            border_side: LEFT
            pad_left: 24
            pad_top: 20
            scrollbar_mode: "off"
            widgets:
              - label:
                  x: 0
                  y: 0
                  text: "VENKOVN√ç"
                  text_font: montserrat_14
                  text_color: 0xa0a0b0
              - label:
                  id: lbl_outdoor_value
                  x: 0
                  y: 36
                  text: "--"
                  text_font: montserrat_44
                  text_color: 0x4cc9f0
              - label:
                  x: 120
                  y: 48
                  text: "oC"
                  text_font: montserrat_20
                  text_color: 0xa0a0b0

        # Indoor Temperature (top right)
        - obj:
            x: 366
            y: 110
            width: 330
            height: 120
            bg_color: 0x252542
            radius: 20
            border_width: 6
            border_color: 0x06d6a0
            border_side: LEFT
            pad_left: 24
            pad_top: 20
            scrollbar_mode: "off"
            widgets:
              - label:
                  x: 0
                  y: 0
                  text: "VNITRNI"
                  text_font: montserrat_14
                  text_color: 0xa0a0b0
              - label:
                  id: lbl_indoor_value
                  x: 0
                  y: 36
                  text: "--"
                  text_font: montserrat_44
                  text_color: 0x06d6a0
              - label:
                  x: 120
                  y: 48
                  text: "oC"
                  text_font: montserrat_20
                  text_color: 0xa0a0b0

        # Humidity (bottom left)
        - obj:
            x: 24
            y: 246
            width: 330
            height: 120
            bg_color: 0x252542
            radius: 20
            border_width: 6
            border_color: 0xb388ff
            border_side: LEFT
            pad_left: 24
            pad_top: 20
            scrollbar_mode: "off"
            widgets:
              - label:
                  x: 0
                  y: 0
                  text: "VLHKOST"
                  text_font: montserrat_14
                  text_color: 0xa0a0b0
              - label:
                  id: lbl_humidity_value
                  x: 0
                  y: 36
                  text: "--"
                  text_font: montserrat_44
                  text_color: 0xb388ff
              - label:
                  x: 120
                  y: 48
                  text: "%"
                  text_font: montserrat_20
                  text_color: 0xa0a0b0

        # CO2 (bottom right)
        - obj:
            x: 366
            y: 246
            width: 330
            height: 120
            bg_color: 0x252542
            radius: 20
            border_width: 6
            border_color: 0xff9f1c
            border_side: LEFT
            pad_left: 24
            pad_top: 20
            scrollbar_mode: "off"
            widgets:
              - label:
                  x: 0
                  y: 0
                  text: "CO2"
                  text_font: montserrat_14
                  text_color: 0xa0a0b0
              - label:
                  id: lbl_co2_value
                  x: 0
                  y: 36
                  text: "--"
                  text_font: montserrat_44
                  text_color: 0xff9f1c
              - label:
                  x: 160
                  y: 48
                  text: "ppm"
                  text_font: montserrat_20
                  text_color: 0xa0a0b0

        # ==================== FAN SECTION ====================
        - obj:
            x: 24
            y: 382
            width: 672
            height: 100
            bg_color: 0x252542
            radius: 20
            border_width: 6
            border_color: 0x4cc9f0
            border_side: LEFT
            pad_all: 20
            scrollbar_mode: "off"
            widgets:
              # Label
              - label:
                  x: 0
                  y: 0
                  text: "RYCHLOST VENTILATORU"
                  text_font: montserrat_14
                  text_color: 0xa0a0b0
              # Value
              - label:
                  id: lbl_fan_value
                  align: TOP_RIGHT
                  x: 0
                  y: -4
                  text: "0%"
                  text_font: montserrat_32
                  text_color: 0x4cc9f0
              # Progress bar background (clickable)
              - obj:
                  id: fan_bar_container
                  x: 0
                  y: 44
                  width: 632
                  height: 20
                  bg_color: 0x1a1a2e
                  radius: 10
                  border_width: 0
                  scrollbar_mode: "off"
                  on_click:
                    then:
                      - mqtt.publish:
                          topic: homehab/panel/command/manualPower
                          payload: !lambda |-
                            if (id(ignore_slider_events)) return std::string("0");
                            lv_point_t point;
                            lv_indev_get_point(lv_indev_get_act(), &point);
                            int power = ((point.x - 44) * 100) / 632;
                            if (power < 0) power = 0;
                            if (power > 100) power = 100;
                            ESP_LOGI("panel", "Fan bar clicked: power=%d", power);
                            return to_string(power);
                  widgets:
                    - bar:
                        id: fan_bar
                        x: 0
                        y: 0
                        width: 632
                        height: 20
                        min_value: 0
                        max_value: 100
                        value: 0
                        bg_opa: TRANSP
                        indicator:
                          bg_color: 0x4cc9f0
                          radius: 10

        # ==================== BOTTOM ROW ====================
        # Bypass Card
        - obj:
            id: bypass_card
            x: 24
            y: 498
            width: 330
            height: 100
            bg_color: 0x252542
            radius: 20
            border_width: 6
            border_color: 0x06d6a0
            border_side: LEFT
            pad_left: 24
            pad_top: 24
            scrollbar_mode: "off"
            on_click:
              - mqtt.publish:
                  topic: homehab/panel/command/bypass
                  payload: !lambda 'return id(bypass_active) ? "OFF" : "ON";'
            widgets:
              - label:
                  x: 0
                  y: 0
                  text: "Bypass"
                  text_font: montserrat_16
                  text_color: 0xFFFFFF
              - label:
                  id: lbl_bypass_status
                  x: 0
                  y: 24
                  text: "Neaktivni"
                  text_font: montserrat_14
                  text_color: 0xa0a0b0
              # Toggle switch
              - obj:
                  id: bypass_toggle
                  align: RIGHT_MID
                  x: -16
                  width: 180
                  height: 42
                  bg_color: 0x1a1a2e
                  radius: 21
                  border_width: 0
                  scrollbar_mode: "off"
                  widgets:
                    - obj:
                        id: bypass_knob
                        x: 4
                        y: 4
                        width: 34
                        height: 34
                        bg_color: 0xa0a0b0
                        radius: 17
                        border_width: 0

        # Alert Card
        - obj:
            id: alert_area
            x: 366
            y: 498
            width: 330
            height: 100
            bg_color: 0x252542
            radius: 20
            border_width: 6
            border_color: 0xa0a0b0
            border_side: LEFT
            widgets:
              - label:
                  id: lbl_alert_text
                  align: CENTER
                  text: "Zadna upozorneni"
                  text_font: montserrat_14
                  text_color: 0xa0a0b0

# Sensors
sensor:
  - platform: uptime
    name: "Uptime"
    update_interval: 60s

binary_sensor:
  - platform: status
    name: "Status"
    id: device_status
    on_state:
      - lambda: 'id(network_connected) = x;'
      - script.execute: update_network_indicator

text_sensor:
  - platform: ethernet_info
    ip_address:
      name: "IP Address"

# Intervals
interval:
  - interval: 1s
    then:
      - lambda: |-
          auto time = id(sntp_time).now();
          if (time.is_valid()) {
            lv_label_set_text_fmt(id(lbl_time), "%02d:%02d", time.hour, time.minute);

            const char* days[] = {"Nedele", "Pondeli", "Utery", "Streda", "Ctvrtek", "Patek", "Sobota"};
            const char* months[] = {"ledna", "unora", "brezna", "dubna", "kvetna", "cervna",
                                    "cervence", "srpna", "zari", "rijna", "listopadu", "prosince"};
            int dow = time.day_of_week - 1;
            if (dow < 0) dow = 6;
            lv_label_set_text_fmt(id(lbl_date), "%s %d. %s", days[dow], time.day_of_month, months[time.month - 1]);
          }

          int timeout = ${screen_timeout};
          if (timeout > 0) {
            id(inactivity_seconds)++;
          }
      - if:
          condition:
            lambda: 'return id(inactivity_seconds) >= ${screen_timeout} && !id(screen_off);'
          then:
            - lambda: 'id(screen_off) = true;'
            - light.turn_off: display_backlight
            - lvgl.pause:

# Scripts
script:
  - id: update_mode_buttons
    then:
      - lambda: |-
          bool off_mode = id(manual_mode_active) && (id(manual_power_value) == 0);
          bool manual_mode = id(temp_manual_mode_active);
          bool boost_mode = id(boost_mode_active);
          bool auto_mode = !id(manual_mode_active) && !id(temp_manual_mode_active) && !id(boost_mode_active);

          // VYP
          lv_obj_set_style_bg_color(id(btn_off), off_mode ? lv_color_hex(0xa0a0b0) : lv_color_hex(0x252542), 0);
          lv_obj_set_style_text_color(lv_obj_get_child(id(btn_off), 0), off_mode ? lv_color_hex(0x1a1a2e) : lv_color_hex(0xa0a0b0), 0);

          // MAN
          lv_obj_set_style_bg_color(id(btn_man), manual_mode ? lv_color_hex(0x4cc9f0) : lv_color_hex(0x252542), 0);
          lv_obj_set_style_text_color(lv_obj_get_child(id(btn_man), 0), manual_mode ? lv_color_hex(0x1a1a2e) : lv_color_hex(0xa0a0b0), 0);

          // BOOST
          lv_obj_set_style_bg_color(id(btn_boost), boost_mode ? lv_color_hex(0xff9f1c) : lv_color_hex(0x252542), 0);
          lv_obj_set_style_text_color(lv_obj_get_child(id(btn_boost), 0), boost_mode ? lv_color_hex(0x1a1a2e) : lv_color_hex(0xa0a0b0), 0);

          // AUTO
          lv_obj_set_style_bg_color(id(btn_auto), auto_mode ? lv_color_hex(0x06d6a0) : lv_color_hex(0x252542), 0);
          lv_obj_set_style_text_color(lv_obj_get_child(id(btn_auto), 0), auto_mode ? lv_color_hex(0x1a1a2e) : lv_color_hex(0xa0a0b0), 0);

  - id: update_network_indicator
    then:
      - lambda: |-
          // Just change icon color: blue=connected, red=disconnected
          lv_obj_set_style_text_color(id(lbl_network_icon),
            id(network_connected) ? lv_color_hex(0x4cc9f0) : lv_color_hex(0xef476f), 0);

  - id: update_bypass_visual
    then:
      - lambda: |-
          if (id(bypass_active)) {
            lv_obj_set_style_border_color(id(bypass_card), lv_color_hex(0x06d6a0), 0);
            lv_label_set_text(id(lbl_bypass_status), "Aktivni");
            lv_obj_set_style_text_color(id(lbl_bypass_status), lv_color_hex(0x06d6a0), 0);
            lv_obj_set_style_bg_color(id(bypass_toggle), lv_color_hex(0x06d6a0), 0);
            lv_obj_set_x(id(bypass_knob), 142);  // 180 - 34 - 4 = 142
            lv_obj_set_style_bg_color(id(bypass_knob), lv_color_hex(0xFFFFFF), 0);
          } else {
            lv_obj_set_style_border_color(id(bypass_card), lv_color_hex(0x252542), 0);
            lv_label_set_text(id(lbl_bypass_status), "Neaktivni");
            lv_obj_set_style_text_color(id(lbl_bypass_status), lv_color_hex(0xa0a0b0), 0);
            lv_obj_set_style_bg_color(id(bypass_toggle), lv_color_hex(0x1a1a2e), 0);
            lv_obj_set_x(id(bypass_knob), 4);
            lv_obj_set_style_bg_color(id(bypass_knob), lv_color_hex(0xa0a0b0), 0);
          }

  - id: update_alerts
    then:
      - lambda: |-
          if (id(gas_alarm)) {
            lv_obj_set_style_bg_color(id(alert_area), lv_color_hex(0xef476f), 0);
            lv_label_set_text(id(lbl_alert_text), "UNIK PLYNU!");
            lv_obj_set_style_text_color(id(lbl_alert_text), lv_color_hex(0xFFFFFF), 0);
          } else if (id(smoke_alarm)) {
            lv_obj_set_style_bg_color(id(alert_area), lv_color_hex(0xef476f), 0);
            lv_label_set_text(id(lbl_alert_text), "DETEKCE KOURE!");
            lv_obj_set_style_text_color(id(lbl_alert_text), lv_color_hex(0xFFFFFF), 0);
          } else if (id(filter_cleaning_required)) {
            lv_obj_set_style_bg_color(id(alert_area), lv_color_hex(0xff9f1c), 0);
            lv_label_set_text(id(lbl_alert_text), "Vycistete filtr");
            lv_obj_set_style_text_color(id(lbl_alert_text), lv_color_hex(0x1a1a2e), 0);
          } else {
            lv_obj_set_style_bg_color(id(alert_area), lv_color_hex(0x252542), 0);
            lv_label_set_text(id(lbl_alert_text), "Zadna upozorneni");
            lv_obj_set_style_text_color(id(lbl_alert_text), lv_color_hex(0xa0a0b0), 0);
          }

  - id: fetch_initial_states
    then:
      - lambda: 'ESP_LOGI("panel", "Fetching initial states...");'
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/hrvOutputPower/state"
          capture_response: true
          on_response:
            - lambda: |-
                if (response->status_code == 200) {
                  int power = atoi(body.c_str());
                  id(power_value) = power;
                  lv_bar_set_value(id(fan_bar), power, LV_ANIM_OFF);
                  lv_label_set_text_fmt(id(lbl_fan_value), "%d%%", power);
                }
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/insideTemperature/state"
          capture_response: true
          on_response:
            - lambda: |-
                if (response->status_code == 200) {
                  int temp = (int)atof(body.c_str());
                  id(inside_temp) = temp;
                  lv_label_set_text_fmt(id(lbl_indoor_value), "%d", temp);
                }
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/outsideTemperature/state"
          capture_response: true
          on_response:
            - lambda: |-
                if (response->status_code == 200) {
                  int temp = (int)atof(body.c_str());
                  id(outside_temp) = temp;
                  lv_label_set_text_fmt(id(lbl_outdoor_value), "%d", temp);
                }
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/airHumidity/state"
          capture_response: true
          on_response:
            - lambda: |-
                if (response->status_code == 200) {
                  lv_label_set_text_fmt(id(lbl_humidity_value), "%d", atoi(body.c_str()));
                }
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/co2/state"
          capture_response: true
          on_response:
            - lambda: |-
                if (response->status_code == 200) {
                  lv_label_set_text_fmt(id(lbl_co2_value), "%d", atoi(body.c_str()));
                }
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/manualMode/state"
          capture_response: true
          on_response:
            - lambda: 'if (response->status_code == 200) id(manual_mode_active) = (body == "ON");'
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/temporaryManualMode/state"
          capture_response: true
          on_response:
            - lambda: 'if (response->status_code == 200) id(temp_manual_mode_active) = (body == "ON");'
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/temporaryBoostMode/state"
          capture_response: true
          on_response:
            - lambda: 'if (response->status_code == 200) id(boost_mode_active) = (body == "ON");'
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/bypass/state"
          capture_response: true
          on_response:
            - lambda: 'if (response->status_code == 200) id(bypass_active) = (body == "ON");'
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/smoke/state"
          capture_response: true
          on_response:
            - lambda: 'if (response->status_code == 200) id(smoke_alarm) = (body == "ON");'
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/gas/state"
          capture_response: true
          on_response:
            - lambda: 'if (response->status_code == 200) id(gas_alarm) = (body == "ON");'
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/filterCleaningRequired/state"
          capture_response: true
          on_response:
            - lambda: 'if (response->status_code == 200) id(filter_cleaning_required) = (body == "ON");'
      - http_request.get:
          url: "http://openhab.home:8888/rest/items/manualPower/state"
          capture_response: true
          on_response:
            - lambda: 'if (response->status_code == 200) id(manual_power_value) = atoi(body.c_str());'
      - script.execute: update_mode_buttons
      - script.execute: update_alerts
      - script.execute: update_bypass_visual
      - script.execute: update_network_indicator
      - lambda: 'ESP_LOGI("panel", "Initial states loaded");'
